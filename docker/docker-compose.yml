version: "3.8"
services:
  # 一次性迁移任务（每次发布先跑它）
  migrate:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        PRISMA_SCHEMA: /app/prisma/schema.prisma
    image: mood-ssr:latest
    container_name: mood-migrate
    restart: "no"
    environment:
      - DATABASE_URL=file:/app/prisma/db/prod.db
      - PRISMA_SCHEMA=/app/prisma/schema.prisma
    volumes:
      - sqlite_data:/app/prisma/db
    command: >
      sh -lc "mkdir -p /app/prisma/db && \
              npx prisma migrate deploy --schema=$PRISMA_SCHEMA || \
              npx prisma db push --schema=$PRISMA_SCHEMA"

  # 应用服务（不做迁移）
  mood-app:
    image: mood-ssr:latest
    container_name: mood-app
    depends_on:
      migrate:
        condition: service_completed_successfully
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - HOST=0.0.0.0
      - PORT=3000
      - NITRO_HOST=0.0.0.0
      - NITRO_PORT=3000
      - DATABASE_URL=file:/app/prisma/db/prod.db
    volumes:
      - ./db:/app/prisma/db
    restart: unless-stopped
